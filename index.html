<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#07070a" />
  <meta name="theme-color" media="(prefers-color-scheme: dark)" content="#07070a" />
  <meta name="theme-color" media="(prefers-color-scheme: light)" content="#07070a" />
  <meta name="color-scheme" content="dark" />
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <title>Inscrição • Coral da Igreja</title>
  <meta property="og:title" content="Coral Graça e Paz" />
  <meta property="og:description" content="Inscrição do Coral Graça e Paz" />
  <meta property="og:image" content="https://coral-igp.vercel.app/og.jpg?v=1" />
  <meta property="og:image:secure_url" content="https://coral-igp.vercel.app/og.jpg?v=1" />
  <meta property="og:image:type" content="image/jpeg" />
  <meta property="og:image:width" content="1200" />
  <meta property="og:image:height" content="630" />
  <meta property="og:image:alt" content="Coral Graça e Paz" />
  <meta property="og:url" content="https://coral-igp.vercel.app" />
  <meta property="og:type" content="website" />
  <meta property="og:locale" content="pt_BR" />
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content="Coral Graça e Paz" />
  <meta name="twitter:description" content="Inscrição do Coral Graça e Paz" />
  <meta name="twitter:image" content="https://coral-igp.vercel.app/og.jpg?v=1" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&family=Sora:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/phosphor-icons@1.4.2/src/css/icons.css">
  <style>
    :root{
      --bg:#07070a;
      --panel:#0f111a;
      --panel-2:#111827;
      --text:#e6e7ee;
      --muted:#9aa3b2;
      --line:rgba(148,163,184,.14);
      --accent:#0a5cff;
      --accent-2:#0047ff;
      --ok:#22c55e;
      --warn:#f59e0b;
      --danger:#ef4444;
      --shadow: 0 20px 60px rgba(0,0,0,.55);
      --radius:18px;
    }
    *{box-sizing:border-box}
    html, body{
      background-color:#07070a;
    }
    body{
      margin:0;
      font-family:"Sora", ui-sans-serif, system-ui;
      color:var(--text);
      background:
        radial-gradient(900px 500px at 5% -10%, rgba(148,163,184,.06), transparent 60%),
        radial-gradient(1000px 600px at 95% -5%, rgba(148,163,184,.06), transparent 55%),
        linear-gradient(180deg, #050509, #0b0b12 45%, #0a0a12 100%);
      min-height:100vh;
    }
    .wrap{max-width:560px;margin:0 auto;padding:22px 30px 54px;position:relative;z-index:1}
    .hero{
      position:relative;
      border-bottom:1px solid var(--line);
      margin:0 0 14px;
    }
    .hero-img{
      width:100%;
      height:auto;
      display:block;
    }
    .hero .wrap{padding:14px 30px 18px}
    .form-section{
      background: linear-gradient(180deg, rgba(12,13,18,.85), rgba(7,7,10,0));
    }
    .form-section .wrap{padding:20px 30px 90px}
    header.top{
      display:flex;flex-direction:column;gap:12px;align-items:flex-start;justify-content:flex-start;
    }
    .meta{
      width:100%;display:grid;gap:8px;align-items:center;
      grid-template-columns: 1fr auto;
    }
    .progress{grid-column:1 / -1}
    .pct{text-align:left}
    .step-pill{text-align:right}
    .step-pill{
      padding:6px 10px;border-radius:999px;border:1px solid var(--line);
      background: rgba(12,13,18,.6);font-size:12px;color:#cbd5e1
    }
    .progress{
      height:8px;border-radius:999px;background:rgba(148,163,184,.12);
      overflow:hidden;width:100%
    }
    .bar{height:100%;width:0%;background:linear-gradient(90deg, var(--accent), var(--accent-2));transition:width .35s ease}
    .pct{font-size:12px;color:var(--muted)}

    .form-shell{
      padding:6px 0 18px;
    }

    form{position:relative}
    .step{display:none;animation:fade .25s ease;min-height:280px}
    .step.active{display:flex;flex-direction:column;gap:6px}
    @keyframes fade{from{opacity:.5;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}
    @keyframes pageIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}

    .step h2{
      margin:0 0 10px;font-family:"Space Grotesk", sans-serif;font-size:20px
    }
    .step p{margin:0 0 12px;color:var(--muted)}

    label{display:block;font-size:13px;color:#cbd5e1;margin:10px 0 6px}
    input[type="text"], input[type="tel"], select{
      width:100%;padding:12px 12px;border-radius:999px;
      border:1px solid rgba(148,163,184,.18);
      background: rgba(255,255,255,.03);color:var(--text);outline:none;
      font-size:16px;
    }
    .dob-grid{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px}
    input[type="text"]:focus, input[type="tel"]:focus, select:focus{
      border-color:rgba(10,92,255,.6);
      box-shadow:0 0 0 3px rgba(10,92,255,.12);
    }
    input::placeholder{color:rgba(148,163,184,.7)}

    .opts{display:grid;gap:10px}
    .opt{
      position:relative;display:flex;align-items:center;justify-content:space-between;gap:10px;
      padding:14px;border-radius:16px;border:1px solid rgba(148,163,184,.16);
      background: rgba(255,255,255,.02);cursor:pointer;transition:all .2s ease
    }
    .opt input{position:absolute;opacity:0;pointer-events:none}
    .optText{color:#e2e8f0}
    .optIcon{opacity:0;color:var(--accent)}
    .opt:hover{border-color:rgba(148,163,184,.28);background: rgba(255,255,255,.04)}
    .opt:focus-within{border-color:rgba(10,92,255,.6);box-shadow:0 0 0 3px rgba(10,92,255,.15)}
    .opt input:checked + .optText{color:#fff}
    .opt input:checked + .optText + .optIcon{opacity:1}
    .opt input:checked ~ .optIcon{opacity:1}
    .opt input:checked ~ .optText{color:#fff}
    .opt input:checked{ }
    .opt input:checked ~ .optIcon{color:var(--accent)}
    .opt input:checked + .optText{font-weight:600}
    .opt input:checked ~ .optIcon i{transform:scale(1.05)}
    .opt input:checked ~ .optIcon{opacity:1}
    .opt input:checked ~ .optText{color:#fff}
    .opt:has(input:checked){
      border-color:rgba(10,92,255,.7);
      background: rgba(10,92,255,.16);
    }

    .subQ{margin-top:10px;display:none}
    .tiny{font-size:12px;color:var(--muted);margin-top:6px}

    .actions{
      display:flex;flex-direction:column;gap:10px;margin-top:18px
    }
    .actions button, .actions .secondary{
      width:100%;height:48px
    }
    button{
      border:0;cursor:pointer;padding:12px 16px;border-radius:999px;
      font-weight:700;color:#0b0a12;background:linear-gradient(90deg, var(--accent), var(--accent-2));
      box-shadow: 0 8px 20px rgba(10,92,255,.25);
      display:inline-flex;align-items:center;justify-content:center;gap:10px;
      letter-spacing:.02em;transition:transform .15s ease, box-shadow .15s ease, opacity .15s ease;
    }
    #nextBtn{color:#fff}
    button:hover{transform:translateY(-1px);box-shadow:0 12px 26px rgba(10,92,255,.28)}
    button:active{transform:translateY(0);box-shadow:0 8px 20px rgba(10,92,255,.22)}
    button.secondary{background: rgba(148,163,184,.14);color:#e2e8f0;box-shadow:none}
    button[disabled]{opacity:.5;cursor:not-allowed}

    .err{color:#fecaca;font-size:12px;margin-top:10px;display:none}

    .result{
      margin-top:18px;padding:16px;border-radius:18px;
      border:1px solid rgba(148,163,184,.16);
      background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      display:none
    }
    .result-head{
      display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:12px
    }
    .result-title{
      font-size:12px;letter-spacing:.2em;text-transform:uppercase;color:var(--muted)
    }
    .pill{
      display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;
      font-size:12px;font-weight:700;border:1px solid transparent
    }
    .pill.ok{background: rgba(10,92,255,.14);border-color: rgba(10,92,255,.35);color:#dbe7ff}
    .pill.warn{background: rgba(0,71,255,.12);border-color: rgba(0,71,255,.35);color:#d6e0ff}
    .result-body{display:flex;flex-direction:column;gap:6px}
    .result-body strong{display:block;font-size:16px;margin:0}
    .result-sub{color:var(--muted);line-height:1.6}
    a.cta{
      display:flex;align-items:center;justify-content:center;gap:8px;text-decoration:none;
      width:100%;
      padding:14px 16px;border-radius:999px;background:#16a34a;
      color:#0b0a12;font-weight:800;margin-top:10px;box-shadow: 0 8px 20px rgba(22,163,74,.25)
    }
    .hint{font-size:12px;color:var(--muted);margin-top:10px}

    .page-in{
      animation: pageIn .5s ease both;
    }

    footer.site-footer{
      position:fixed;left:0;right:0;bottom:0;
      text-align:center;
      color:var(--muted);
      font-size:12px;
      padding:10px 0 calc(10px + env(safe-area-inset-bottom));
      background: rgba(7,7,10,.7);
      border-top:1px solid var(--line);
      backdrop-filter: blur(6px);
      z-index:2;
    }

    @supports (-webkit-touch-callout: none){
      body{padding-bottom: env(safe-area-inset-bottom);}
      .form-section{padding-bottom: env(safe-area-inset-bottom);}
    }

    .modal{
      position:fixed;inset:0;display:none;place-items:center;
      background: rgba(0,0,0,.55);
      backdrop-filter: blur(6px);
      z-index:4;
      padding:20px;
    }
    .modal.open{display:grid}
    .modal-card{
      width:100%;max-width:420px;
      background: linear-gradient(180deg, rgba(18,20,28,.98), rgba(12,14,20,.98));
      border:1px solid rgba(148,163,184,.18);
      border-radius:20px;
      box-shadow: var(--shadow);
      padding:18px;
      display:grid;gap:12px;
      text-align:left;
      position:relative;
    }
    .modal-head{
      display:flex;gap:10px;align-items:center;
    }
    .modal-icon{
      width:40px;height:40px;border-radius:999px;
      display:grid;place-items:center;
      background: rgba(10,92,255,.12);
      color:var(--accent);
      font-size:20px;
      border:1px solid rgba(10,92,255,.25);
      overflow:hidden;
    }
    .modal-icon.danger{
      background: rgba(239,68,68,.12);
      color:#fecaca;
      border-color: rgba(239,68,68,.35);
    }
    .avatar{
      width:100%;height:100%;object-fit:cover;display:block;
    }
    .modal-title{font-size:16px;font-weight:700}
    .modal-sub{font-size:12px;color:var(--muted);margin-top:2px}
    .modal-text{color:var(--muted);line-height:1.6}
    .modal-actions{display:flex;gap:10px}
    .modal-actions .secondary{width:100%}
    .score-pill{
      margin-left:auto;
      padding:4px 8px;border-radius:999px;
      font-size:11px;font-weight:700;
      border:1px solid transparent;
      display:flex;align-items:baseline;gap:4px;
    }
    .score-label{opacity:.85}
    .score-val{font-size:14px;font-weight:800}
    .score-unit{font-size:11px;font-weight:300;opacity:.8}
    .score-pill.low{background: rgba(239,68,68,.12);color:#fecaca;border-color: rgba(239,68,68,.35)}
    .score-pill.mid{background: rgba(255,255,255,.08);color:#f8fafc;border-color: rgba(148,163,184,.25)}
    .score-pill.high{background: rgba(34,197,94,.14);color:#bbf7d0;border-color: rgba(34,197,94,.35)}
    .modal-close{
      position:absolute;top:10px;right:10px;
      width:32px;height:32px;border-radius:999px;
      border:1px solid rgba(148,163,184,.18);
      background: rgba(255,255,255,.04);
      color:var(--text);
      display:grid;place-items:center;
      cursor:pointer;
    }

    .result-modal .modal-card{max-width:520px}
    .result-modal .modal-actions{flex-direction:column}

    @media (min-width:720px){
      .wrap{max-width:560px}
    }
  </style>
</head>
<body>
  <section class="hero page-in">
    <img class="hero-img" src="bg.png" alt="" aria-hidden="true" />
    <div class="wrap">
      <header class="top">
        <div class="meta">
          <div class="step-pill">Etapa <span id="stepNum">1</span>/<span id="stepTotal">6</span></div>
          <div class="progress" aria-hidden="true"><div class="bar" id="bar"></div></div>
          <div class="pct" id="pct">0%</div>
        </div>
      </header>
    </div>
  </section>

  <section class="form-section page-in">
    <div class="wrap">
      <main class="form-shell" aria-label="Formulário">
        <form id="leadForm" novalidate>
          <section class="step active" data-step="0">
          <h2><i class="ph ph-user-circle"></i> Seus dados</h2>
          <p>Essas informações ajudam no primeiro contato.</p>
          <label for="name">Seu nome</label>
          <input id="name" name="name" type="text" placeholder="Ex: Maria Silva" required />

          <label for="whats">WhatsApp</label>
          <input id="whats" name="whats" type="tel" placeholder="DDD + número (ex: 27 99999-9999)" required />
          
          <label for="dobDay">Data de nascimento</label>
          <div class="dob-grid">
            <select id="dobDay" name="dobDay" required>
              <option value="">Dia</option>
            </select>
            <select id="dobMonth" name="dobMonth" required>
              <option value="">Mês</option>
            </select>
            <select id="dobYear" name="dobYear" required>
              <option value="">Ano</option>
            </select>
          </div>

          <div class="err stepErr">Preencha nome e WhatsApp corretamente.</div>
          <div class="err dobErr">Selecione a data de nascimento.</div>
        </section>

        <section class="step" data-step="1">
          <h2><i class="ph ph-church"></i> 1) Você faz parte ou já fez parte do MMG?</h2>
          <div class="opts" role="radiogroup" aria-label="MMG">
            <label class="opt">
              <input type="radio" name="mmg" value="atual" required />
              <span class="optText">Sim, faço parte atualmente</span>
              <span class="optIcon"><i class="ph ph-check-circle"></i></span>
            </label>
            <label class="opt">
              <input type="radio" name="mmg" value="antes" />
              <span class="optText">Já fiz parte antes</span>
              <span class="optIcon"><i class="ph ph-check-circle"></i></span>
            </label>
            <label class="opt">
              <input type="radio" name="mmg" value="nunca" />
              <span class="optText">Nunca participei</span>
              <span class="optIcon"><i class="ph ph-check-circle"></i></span>
            </label>
          </div>
          <div class="err stepErr">Selecione uma opção.</div>
        </section>

        <section class="step" data-step="2">
          <h2><i class="ph ph-microphone-stage"></i> 2) Você já cantou em coral ou grupo vocal?</h2>
          <div class="opts" role="radiogroup" aria-label="Experiência em coral">
            <label class="opt">
              <input type="radio" name="choir" value="sim" required />
              <span class="optText">Sim</span>
              <span class="optIcon"><i class="ph ph-check-circle"></i></span>
            </label>
            <label class="opt">
              <input type="radio" name="choir" value="nao" />
              <span class="optText">Não</span>
              <span class="optIcon"><i class="ph ph-check-circle"></i></span>
            </label>
          </div>

          <div class="subQ" id="choirTimeWrap">
            <label for="choirTime">Se sim, por quanto tempo?</label>
            <select id="choirTime" name="choirTime">
              <option value="">Selecione</option>
              <option value="lt6">Menos de 6 meses</option>
              <option value="6-12">6 a 12 meses</option>
              <option value="1-3">1 a 3 anos</option>
              <option value="3p">Mais de 3 anos</option>
            </select>
            <div class="tiny">Isso ajuda a te posicionar melhor na voz correta.</div>
          </div>
          <div class="err stepErr">Selecione uma opção e, se sim, informe o tempo.</div>
        </section>

        <section class="step" data-step="3">
          <h2><i class="ph ph-waveform"></i> 3) Quando a música muda de tom, você acompanha sem travar?</h2>
          <div class="opts" role="radiogroup" aria-label="Mudança de tom">
            <label class="opt">
              <input type="radio" name="pitch" value="bem" required />
              <span class="optText">Sim, acompanho bem</span>
              <span class="optIcon"><i class="ph ph-check-circle"></i></span>
            </label>
            <label class="opt">
              <input type="radio" name="pitch" value="asvezes" />
              <span class="optText">Às vezes tenho dificuldade</span>
              <span class="optIcon"><i class="ph ph-check-circle"></i></span>
            </label>
            <label class="opt">
              <input type="radio" name="pitch" value="muito" />
              <span class="optText">Tenho muita dificuldade</span>
              <span class="optIcon"><i class="ph ph-check-circle"></i></span>
            </label>
          </div>
          <div class="err stepErr">Selecione uma opção.</div>
        </section>

        <section class="step" data-step="4">
          <h2><i class="ph ph-music-notes"></i> 4) Qual é a sua voz (se souber)?</h2>
          <div class="opts" role="radiogroup" aria-label="Voz">
            <label class="opt">
              <input type="radio" name="voice" value="soprano" required />
              <span class="optText">Soprano</span>
              <span class="optIcon"><i class="ph ph-check-circle"></i></span>
            </label>
            <label class="opt">
              <input type="radio" name="voice" value="contralto" />
              <span class="optText">Contralto</span>
              <span class="optIcon"><i class="ph ph-check-circle"></i></span>
            </label>
            <label class="opt">
              <input type="radio" name="voice" value="tenor" />
              <span class="optText">Tenor</span>
              <span class="optIcon"><i class="ph ph-check-circle"></i></span>
            </label>
            <label class="opt">
              <input type="radio" name="voice" value="baixo" />
              <span class="optText">Baixo</span>
              <span class="optIcon"><i class="ph ph-check-circle"></i></span>
            </label>
            <label class="opt">
              <input type="radio" name="voice" value="naosei" />
              <span class="optText">Não sei</span>
              <span class="optIcon"><i class="ph ph-check-circle"></i></span>
            </label>
          </div>
          <div class="err stepErr">Selecione uma opção.</div>
        </section>

        <section class="step" data-step="5">
          <h2><i class="ph ph-calendar"></i> 5) Você tem disponibilidade para ensaio semanal?</h2>
          <div class="opts" role="radiogroup" aria-label="Disponibilidade">
            <label class="opt">
              <input type="radio" name="avail" value="sim" required />
              <span class="optText">Sim</span>
              <span class="optIcon"><i class="ph ph-check-circle"></i></span>
            </label>
            <label class="opt">
              <input type="radio" name="avail" value="depende" />
              <span class="optText">Depende</span>
              <span class="optIcon"><i class="ph ph-check-circle"></i></span>
            </label>
            <label class="opt">
              <input type="radio" name="avail" value="nao" />
              <span class="optText">Não</span>
              <span class="optIcon"><i class="ph ph-check-circle"></i></span>
            </label>
          </div>
          <div class="err stepErr">Selecione uma opção.</div>
        </section>

        <div class="actions">
          <button type="button" class="secondary" id="prevBtn">Voltar</button>
          <button type="button" id="nextBtn">Continuar</button>
        </div>

        <div class="err" id="err">Preencha os dados e responda todas as perguntas.</div>

        <div class="result" id="result">
          <div class="result-head">
            <div class="pill" id="pill"></div>
            <div class="result-title">Resultado</div>
          </div>
          <div class="result-body" id="resultText"></div>
          <a class="cta" id="cta" href="#" target="_blank" rel="noopener">
            <i class="ph ph-phone-call"></i> Falar no WhatsApp
          </a>
          <div class="hint" id="hint"></div>
        </div>
        </form>
      </main>
    </div>
  </section>

  <footer class="site-footer">Alexandre Siqueira de Paula - MMG</footer>

  <div class="modal" id="ageModal" role="dialog" aria-modal="true" aria-labelledby="ageModalTitle">
    <div class="modal-card">
      <button class="modal-close" id="ageModalClose" aria-label="Fechar"><i class="ph ph-x"></i></button>
      <div class="modal-head">
        <div class="modal-icon">
          <img class="avatar" src="mery.jpeg" alt="Tia Mery" />
        </div>
        <div class="modal-title" id="ageModalTitle">Falar com Tia Mery</div>
      </div>
      <div class="modal-text">Para você que tem menos de 12 anos, a inscrição é feita diretamente com a Tia Mery. Clique no botão abaixo para conversar com ela.</div>
      <div class="modal-actions">
        <a class="cta" href="https://wa.me/27996187340" target="_blank" rel="noopener">
          <i class="ph ph-whatsapp-logo"></i> Falar no WhatsApp
        </a>
      </div>
    </div>
  </div>

  <div class="modal result-modal" id="resultModal" role="dialog" aria-modal="true" aria-labelledby="resultModalTitle">
    <div class="modal-card">
      <div class="modal-head">
        <div class="modal-icon" id="resultModalIcon"><i class="ph ph-check-circle"></i></div>
        <div>
          <div class="modal-title" id="resultModalTitle">Resultado</div>
          <div class="modal-sub" id="resultModalSub"></div>
        </div>
        <div class="score-pill" id="scorePill">Nota 0/10</div>
      </div>
      <div class="result-body" id="resultTextModal"></div>
      <div class="modal-actions">
        <a class="cta" id="ctaModal" href="#" target="_blank" rel="noopener">
          <i class="ph ph-phone-call"></i> Falar no WhatsApp
        </a>
        <button type="button" class="secondary" id="resultModalClose">Fechar</button>
      </div>
      <div class="hint" id="hintModal"></div>
    </div>
  </div>

  <script>
    // ====== CONFIGURE AQUI ======
    const GROUP_INVITE_LINK = "https://chat.whatsapp.com/CBSgRJlUCBFE4hrytjMrPB?mode=gi_t"; // ex: https://chat.whatsapp.com/XXXX
    const CONTACTS = {
      xandy: { name: "Xandy", phone: "27998721786", avatar: "xandy.png" },
      mery: { name: "Tia Mery", phone: "27996187340", avatar: "mery.jpeg" }
    };
    // ============================

    const form = document.getElementById("leadForm");
    const bar = document.getElementById("bar");
    const pct = document.getElementById("pct");
    const stepNum = document.getElementById("stepNum");
    const stepTotal = document.getElementById("stepTotal");
    const err = document.getElementById("err");
    const result = document.getElementById("result");
    const pill = document.getElementById("pill");
    const resultText = document.getElementById("resultText");
    const cta = document.getElementById("cta");
    const hint = document.getElementById("hint");
    const resultModal = document.getElementById("resultModal");
    const resultModalIcon = document.getElementById("resultModalIcon");
    const resultModalTitle = document.getElementById("resultModalTitle");
    const resultModalSub = document.getElementById("resultModalSub");
    const scorePill = document.getElementById("scorePill");
    const resultTextModal = document.getElementById("resultTextModal");
    const ctaModal = document.getElementById("ctaModal");
    const hintModal = document.getElementById("hintModal");
    const resultModalClose = document.getElementById("resultModalClose");
    const prevBtn = document.getElementById("prevBtn");
    const nextBtn = document.getElementById("nextBtn");
    const submitBtn = document.getElementById("submitBtn");
    const choirTimeWrap = document.getElementById("choirTimeWrap");
    const choirTime = document.getElementById("choirTime");
    const ageModal = document.getElementById("ageModal");
    const ageModalClose = document.getElementById("ageModalClose");
    const dobDay = document.getElementById("dobDay");
    const dobMonth = document.getElementById("dobMonth");
    const dobYear = document.getElementById("dobYear");

    const steps = Array.from(document.querySelectorAll(".step"));
    let currentStep = 0;

    function digitsOnly(s){ return (s || "").replace(/\D/g, ""); }

    function normalizeBRPhone(input){
      const d = digitsOnly(input);
      if(!d) return "";
      if(d.startsWith("55") && d.length >= 12) return d;
      if(d.length === 10 || d.length === 11) return "55" + d;
      return d.length >= 12 ? d : "";
    }

    function clamp(n, min, max){
      return Math.max(min, Math.min(max, n));
    }

    function calcScore(data){
      let score = 3;
      if(data.avail === "sim") score += 2;
      if(data.avail === "depende") score += 1;
      if(data.mmg === "atual") score += 1;
      if(data.mmg === "antes") score += 1;
      if(data.choir === "sim") score += 1;
      if(data.choirTime === "6-12") score += 1;
      if(data.choirTime === "1-3") score += 2;
      if(data.choirTime === "3p") score += 3;
      if(data.pitch === "bem") score += 2;
      if(data.pitch === "asvezes") score += 1;
      if(data.pitch === "muito") score -= 1;
      if(data.voice !== "naosei") score += 1;
      return clamp(score, 3, 10);
    }

    function openWhatsApp(phone, text){
      const enc = encodeURIComponent(text || "");
      const api = `https://api.whatsapp.com/send?phone=${phone}${text ? `&text=${enc}` : ""}`;
      const wa = `https://wa.me/${phone}${text ? `?text=${enc}` : ""}`;
      const isAndroid = /Android/i.test(navigator.userAgent || "");

      if(isAndroid && text){
        const intent = `intent://send?phone=${phone}&text=${enc}#Intent;scheme=whatsapp;package=com.whatsapp;end`;
        window.location.href = intent;
        setTimeout(() => { window.location.href = api; }, 700);
        return;
      }
      window.open(wa, "_blank");
    }

    function getDobISO(){
      if(!dobDay || !dobMonth || !dobYear) return "";
      const d = parseInt(dobDay.value, 10);
      const m = parseInt(dobMonth.value, 10);
      const y = parseInt(dobYear.value, 10);
      if(!d || !m || !y) return "";
      const date = new Date(y, m - 1, d);
      if(date.getFullYear() !== y || date.getMonth() !== (m - 1) || date.getDate() !== d) return "";
      return `${y}-${String(m).padStart(2,"0")}-${String(d).padStart(2,"0")}`;
    }

    function isAtLeast12(dobStr){
      if(!dobStr) return false;
      const dob = new Date(dobStr + "T00:00:00");
      if(Number.isNaN(dob.getTime())) return false;
      const today = new Date();
      const cutoff = new Date(today.getFullYear() - 12, today.getMonth(), today.getDate());
      return dob <= cutoff;
    }

    function getRadio(name){
      const el = form.querySelector(`input[name="${name}"]:checked`);
      return el ? el.value : "";
    }

    function updateProgress(){
      stepTotal.textContent = steps.length;
      stepNum.textContent = Math.min(currentStep + 1, steps.length);
      const p = Math.round((currentStep / (steps.length - 1)) * 100);
      bar.style.width = p + "%";
      pct.textContent = p + "%";
    }

    function showStep(i){
      steps.forEach((s, idx) => s.classList.toggle("active", idx === i));
      if(prevBtn) prevBtn.style.display = i === 0 ? "none" : "inline-flex";
      if(nextBtn) nextBtn.style.display = i === 0 ? "inline-flex" : "none";
      if(submitBtn) submitBtn.style.display = "none";
      err.style.display = "none";
      updateProgress();
    }

    function showStepError(i, show){
      const step = steps[i];
      const stepErr = step ? step.querySelector(".stepErr") : null;
      if(stepErr) stepErr.style.display = show ? "block" : "none";
    }
    function showAgeModal(){
      if(ageModal) ageModal.classList.add("open");
    }
    function hideAgeModal(){
      if(ageModal) ageModal.classList.remove("open");
    }
    function showResultModal(){
      if(resultModal) resultModal.classList.add("open");
    }
    function hideResultModal(){
      if(resultModal) resultModal.classList.remove("open");
    }

    function validateStep(i){
      showStepError(i, false);
      const step = steps[i];
      if(i === 0){
        const nameOk = form.name.value.trim().length > 1;
        const phoneOk = !!normalizeBRPhone(form.whats.value);
        const dobStr = getDobISO();
        const dobFilled = !!(dobDay && dobDay.value && dobMonth && dobMonth.value && dobYear && dobYear.value);
        const ageOk = isAtLeast12(dobStr);
        const dobErr = step ? step.querySelector(".dobErr") : null;
        if(dobErr) dobErr.style.display = "none";
        const ok = nameOk && phoneOk && ageOk;
        if(!(nameOk && phoneOk)) showStepError(i, true);
        if(!dobFilled && dobErr) dobErr.style.display = "block";
        if(dobFilled && !dobStr && dobErr) {
          dobErr.textContent = "Data inválida. Verifique o dia, mês e ano.";
          dobErr.style.display = "block";
          return false;
        }
        if(dobFilled && dobStr) {
          dobErr.textContent = "Selecione a data de nascimento.";
        }
        if(dobFilled && dobStr && !ageOk){
          showAgeModal();
        }
        return ok;
      }
      if(i === 1){
        const ok = !!getRadio("mmg");
        if(!ok) showStepError(i, true);
        return ok;
      }
      if(i === 2){
        const choirVal = getRadio("choir");
        const ok = !!choirVal && (choirVal === "nao" || (choirVal === "sim" && !!choirTime.value));
        if(!ok) showStepError(i, true);
        return ok;
      }
      if(i === 3){
        const ok = !!getRadio("pitch");
        if(!ok) showStepError(i, true);
        return ok;
      }
      if(i === 4){
        const ok = !!getRadio("voice");
        if(!ok) showStepError(i, true);
        return ok;
      }
      if(i === 5){
        const ok = !!getRadio("avail");
        if(!ok) showStepError(i, true);
        return ok;
      }
      return true;
    }

    form.addEventListener("input", () => {
      const choirVal = getRadio("choir");
      if(choirVal === "sim"){
        choirTimeWrap.style.display = "block";
      } else {
        choirTimeWrap.style.display = "none";
        choirTime.value = "";
      }

      if(currentStep === 0){
        // Avança manualmente no botão "Continuar"
        return;
      }
    });

    form.addEventListener("change", (e) => {
      const step = steps[currentStep];
      if(!step || !step.contains(e.target)) return;

      if(currentStep === 0){
        return;
      }

      if(e.target.matches('input[type="radio"]')){
        if(currentStep === 2){
          const choirVal = getRadio("choir");
          if(choirVal === "sim" && !choirTime.value) return;
        }
        if(currentStep === steps.length - 1){
          form.requestSubmit();
        } else {
          tryAutoAdvance();
        }
      }

      if(currentStep === 2 && e.target === choirTime && choirTime.value){
        if(getRadio("choir") === "sim") tryAutoAdvance();
      }
    });

    prevBtn.addEventListener("click", () => {
      if(currentStep > 0){
        currentStep -= 1;
        showStep(currentStep);
      }
    });

    function tryAutoAdvance(){
      if(currentStep >= steps.length - 1) return;
      if(!validateStep(currentStep)) return;
      currentStep = Math.min(currentStep + 1, steps.length - 1);
      showStep(currentStep);
    }

    if(nextBtn){
      nextBtn.addEventListener("click", () => {
        if(validateStep(currentStep)){
          currentStep = Math.min(currentStep + 1, steps.length - 1);
          showStep(currentStep);
        }
      });
    }

    function buildMessage(data, decision){
      const mmgMap = { atual:"Sim (atual)", antes:"Já fez parte", nunca:"Nunca" };
      const choirMap = { sim:"Sim", nao:"Não" };
      const pitchMap = { bem:"Acompanha bem", asvezes:"Às vezes", muito:"Muita dificuldade" };
      const availMap = { sim:"Sim", depende:"Depende", nao:"Não" };
      const voiceMap = { soprano:"Soprano", contralto:"Contralto", tenor:"Tenor", baixo:"Baixo", naosei:"Não sei" };

      return (
`Olá! Sou ${data.name}
Quero participar do Coral.

Resumo:
- MMG: ${mmgMap[data.mmg] || "-"}
- Coral/Grupo vocal: ${choirMap[data.choir] || "-"}${data.choir==="sim" && data.choirTime ? ` (${data.choirTime})` : ""}
- Mudança de tom: ${pitchMap[data.pitch] || "-"}
- Voz: ${voiceMap[data.voice] || "-"}
- Ensaio semanal: ${availMap[data.avail] || "-"}

Direcionamento do formulário: ${decision}
`
      );
    }

    form.addEventListener("submit", (e) => {
      e.preventDefault();
      err.style.display = "none";
      result.style.display = "none";

      if(!validateStep(currentStep)) return;

      const name = form.name.value.trim();
      const phone = normalizeBRPhone(form.whats.value);
      const data = {
        name,
        phone,
        mmg: getRadio("mmg"),
        choir: getRadio("choir"),
        choirTime: choirTime.value,
        pitch: getRadio("pitch"),
        voice: getRadio("voice"),
        avail: getRadio("avail"),
      };

      const ok =
        name.length > 1 &&
        !!phone &&
        isAtLeast12(getDobISO()) &&
        data.mmg && data.choir && data.pitch && data.voice && data.avail &&
        (data.choir !== "sim" || !!data.choirTime);

      if(!ok){
        err.style.display = "block";
        if(getDobISO() && !isAtLeast12(getDobISO())) showAgeModal();
        return;
      }

      const score = calcScore(data);
      scorePill.innerHTML = `<span class="score-label">Nota</span> <span class="score-val">${score}</span><span class="score-unit">/10</span>`;
      scorePill.className = "score-pill";

      if(score >= 9){
        resultModalIcon.className = "modal-icon";
        scorePill.classList.add("high");
        pill.className = "pill ok";
        pill.textContent = "Acesso direto";
        resultModalIcon.innerHTML = '<i class="ph ph-check-circle"></i>';
        resultModalTitle.textContent = "Direto para o grupo";
        resultModalSub.textContent = "Aprovado no fluxo principal";
        resultText.innerHTML = `
          <strong>Olá ${name}!</strong>
          <div class="result-sub">Cadastro confirmado. Você já pode entrar no grupo do coral para receber horários, repertório e próximos passos.</div>
        `;
        resultTextModal.innerHTML = resultText.innerHTML;
        cta.textContent = "Entrar no grupo do Coral";
        cta.href = GROUP_INVITE_LINK || "#";
        ctaModal.textContent = cta.textContent;
        ctaModal.href = cta.href;
        ctaModal.dataset.mode = "link";
        ctaModal.hidden = false;
        ctaModal.style.display = "flex";
        hint.textContent = "Se o link não abrir, fale comigo no WhatsApp que eu te adiciono.";
        hintModal.textContent = hint.textContent;
      } else if(score >= 5){
        resultModalIcon.className = "modal-icon";
        scorePill.classList.add("mid");
        const contact = CONTACTS.xandy;
        pill.className = "pill warn";
        pill.textContent = "Contato rápido";
        resultModalIcon.innerHTML = `<img class="avatar" src="${contact.avatar}" alt="${contact.name}" />`;
        resultModalTitle.textContent = `Falar com ${contact.name}`;
        resultModalSub.textContent = "Redirecionamento para atendimento";
        resultText.innerHTML = `
          <strong>Olá ${name}!</strong>
          <div class="result-sub">Antes de entrar no grupo, precisamos alinhar voz, base e rotina de ensaio. É rápido.</div>
        `;
        resultTextModal.innerHTML = resultText.innerHTML;
        const msg = buildMessage(data, `Conversa com ${contact.name} • Nota ${score}/10`);
        cta.textContent = `Falar com ${contact.name}`;
        cta.href = `https://api.whatsapp.com/send?phone=${contact.phone}&text=${encodeURIComponent(msg)}`;
        ctaModal.textContent = cta.textContent;
        ctaModal.href = cta.href;
        ctaModal.dataset.mode = "whatsapp";
        ctaModal.dataset.phone = contact.phone;
        ctaModal.dataset.text = msg;
        ctaModal.hidden = false;
        ctaModal.style.display = "flex";
        hint.textContent = "Contato direto para orientação.";
        hintModal.textContent = hint.textContent;
      } else {
        resultModalIcon.className = "modal-icon danger";
        scorePill.classList.add("low");
        pill.className = "pill warn";
        pill.textContent = "Não aprovado";
        resultModalIcon.innerHTML = '<i class="ph ph-x-circle-fill"></i>';
        resultModalTitle.textContent = "Infelizmente você não passou";
        resultModalSub.textContent = "Não foi possível avançar";
        resultText.innerHTML = `
          <strong>Olá ${name}!</strong>
          <div class="result-sub">Para cantar na Festa de Purim (07 de março de 2026), precisamos de mais ensaio e um pouco mais de experiência. Continue praticando e volte a se inscrever na próxima festa.</div>
        `;
        resultTextModal.innerHTML = resultText.innerHTML;
        ctaModal.hidden = true;
        ctaModal.style.display = "none";
        ctaModal.removeAttribute("href");
        delete ctaModal.dataset.mode;
        delete ctaModal.dataset.phone;
        delete ctaModal.dataset.text;
        hint.textContent = "";
        hintModal.textContent = "";
      }

      result.style.display = "none";
      showResultModal();
    });

    ageModalClose.addEventListener("click", hideAgeModal);
    ageModal.addEventListener("click", (e) => {
      if(e.target === ageModal) hideAgeModal();
    });
    resultModalClose.addEventListener("click", hideResultModal);
    resultModal.addEventListener("click", (e) => {
      if(e.target === resultModal) hideResultModal();
    });
    ctaModal.addEventListener("click", (e) => {
      if(ctaModal.dataset.mode === "whatsapp"){
        e.preventDefault();
        openWhatsApp(ctaModal.dataset.phone, ctaModal.dataset.text);
      }
    });

    // init
    if(dobDay && dobMonth && dobYear){
      for(let d = 1; d <= 31; d++){
        const opt = document.createElement("option");
        opt.value = String(d);
        opt.textContent = String(d);
        dobDay.appendChild(opt);
      }
      const months = ["Jan","Fev","Mar","Abr","Mai","Jun","Jul","Ago","Set","Out","Nov","Dez"];
      months.forEach((m, idx) => {
        const opt = document.createElement("option");
        opt.value = String(idx + 1);
        opt.textContent = m;
        dobMonth.appendChild(opt);
      });
      const currentYear = new Date().getFullYear();
      for(let y = currentYear; y >= 1900; y--){
        const opt = document.createElement("option");
        opt.value = String(y);
        opt.textContent = String(y);
        dobYear.appendChild(opt);
      }
    }
    showStep(currentStep);
  </script>
</body>
</html>
